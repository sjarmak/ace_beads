#!/usr/bin/env node

/**
 * ACE Knowledge Review Toolbox Script
 * 
 * Reviews AGENTS.md for duplicate bullets and archival candidates.
 * Generates a review report with proposed cleanups.
 * 
 * Usage:
 *   ace-review [agentsPath: /path/to/AGENTS.md] [format: json|markdown]
 */

import fs from 'fs';
import path from 'path';

const action = process.env.TOOLBOX_ACTION;

if (action === 'describe') {
  process.stdout.write([
    'name: ace-review',
    'description: Review AGENTS.md for duplicate bullets and archival candidates',
    'agentsPath: string path to AGENTS.md file (optional, defaults to ./AGENTS.md)',
    'format: string output format - "json" or "markdown" (default: markdown)',
  ].join('\n'));
} else if (action === 'execute') {
  // Read parameters from stdin
  const input = fs.readFileSync(0, 'utf-8');
  const pathMatch = input.match(/agentsPath: (.+)/);
  const formatMatch = input.match(/format: (json|markdown)/);
  
  const agentsPath = pathMatch ? pathMatch[1].trim() : path.join(process.cwd(), 'AGENTS.md');
  const format = formatMatch ? formatMatch[1] : 'markdown';
  
  console.log('ðŸ” ACE Knowledge Review Starting...\n');
  console.log(`ðŸ“‚ Reviewing: ${agentsPath}\n`);
  
  if (!fs.existsSync(agentsPath)) {
    console.error(`âŒ Error: AGENTS.md not found at ${agentsPath}`);
    process.exit(1);
  }
  
  // Import and run the analyzer
  const distPath = path.join(process.cwd(), 'dist', 'mcp', 'knowledge-analyzer.js');
  
  if (!fs.existsSync(distPath)) {
    console.error('âŒ Error: knowledge-analyzer not built. Run: npm run build');
    process.exit(1);
  }
  
  import(distPath).then(({ KnowledgeAnalyzer }) => {
    const analyzer = new KnowledgeAnalyzer();
    
    analyzer.generateReviewReport(agentsPath).then(report => {
      if (format === 'json') {
        console.log(JSON.stringify(report, null, 2));
      } else {
        printMarkdownReport(report);
      }
    }).catch(error => {
      console.error('âŒ Error generating report:', error.message);
      process.exit(1);
    });
  }).catch(error => {
    console.error('âŒ Error loading analyzer:', error.message);
    process.exit(1);
  });
}

function printMarkdownReport(report) {
  console.log('# AGENTS.md Review Report');
  console.log(`\n**Generated:** ${new Date(report.timestamp).toLocaleString()}`);
  console.log(`**Total Bullets:** ${report.totalBullets}`);
  console.log(`**Estimated Token Savings:** ${report.estimatedTokenSavings}`);
  
  console.log('\n## Duplicate Clusters\n');
  if (report.duplicateClusters.length === 0) {
    console.log('âœ… No duplicate bullets found');
  } else {
    report.duplicateClusters.forEach((cluster, i) => {
      console.log(`### Cluster ${i + 1}`);
      console.log(`**Representative:** [#${cluster.representative.id}] ${cluster.representative.text.substring(0, 80)}...`);
      console.log(`**Helpful:** ${cluster.representative.helpfulCount} â†’ **Merged:** ${cluster.mergedHelpfulCount}`);
      console.log(`**Harmful:** ${cluster.representative.harmfulCount} â†’ **Merged:** ${cluster.mergedHarmfulCount}`);
      console.log(`\n**Duplicates to remove:**`);
      cluster.duplicates.forEach(dup => {
        console.log(`  - [#${dup.id}] (helpful:${dup.helpfulCount}, harmful:${dup.harmfulCount})`);
      });
      console.log('');
    });
  }
  
  console.log('\n## Archival Candidates\n');
  if (report.archivalCandidates.length === 0) {
    console.log('âœ… No archival candidates found');
  } else {
    const byReason = {
      'zero-helpful': [],
      'low-signal': [],
      'high-harmful': []
    };
    
    report.archivalCandidates.forEach(candidate => {
      byReason[candidate.reason].push(candidate);
    });
    
    if (byReason['zero-helpful'].length > 0) {
      console.log('### Zero Helpful Count (Never Applied)\n');
      byReason['zero-helpful'].forEach(c => {
        console.log(`- [#${c.bullet.id}] ${c.bullet.text.substring(0, 80)}...`);
      });
      console.log('');
    }
    
    if (byReason['low-signal'].length > 0) {
      console.log('### Low Signal (Zero Helpful, Some Harmful)\n');
      byReason['low-signal'].forEach(c => {
        console.log(`- [#${c.bullet.id}] (harmful:${c.bullet.harmfulCount}) ${c.bullet.text.substring(0, 80)}...`);
      });
      console.log('');
    }
    
    if (byReason['high-harmful'].length > 0) {
      console.log('### High Harmful Ratio (harmful > helpful * 2)\n');
      byReason['high-harmful'].forEach(c => {
        console.log(`- [#${c.bullet.id}] (helpful:${c.bullet.helpfulCount}, harmful:${c.bullet.harmfulCount}, ratio:${c.harmfulToHelpfulRatio.toFixed(2)}) ${c.bullet.text.substring(0, 60)}...`);
      });
      console.log('');
    }
  }
  
  console.log('\n## Summary\n');
  console.log(`- **Duplicate clusters:** ${report.duplicateClusters.length}`);
  console.log(`- **Bullets to merge:** ${report.duplicateClusters.reduce((sum, c) => sum + c.duplicates.length, 0)}`);
  console.log(`- **Bullets to archive:** ${report.archivalCandidates.length}`);
  console.log(`- **Total cleanup:** ${report.duplicateClusters.reduce((sum, c) => sum + c.duplicates.length, 0) + report.archivalCandidates.length} bullets`);
  console.log(`- **Token savings:** ~${report.estimatedTokenSavings} tokens\n`);
  
  console.log('âœ… Review complete!\n');
}
